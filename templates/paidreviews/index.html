{% extends "base.html" %} {% from "macros.jinja" import window_vars with context %}
{% block scripts %} {{ window_vars(user) }}
<script src="{{ static_url_for('paidreviews/static', path='js/index.js') }}"></script>
{% endblock %}

{% block page %}
<div class="row q-col-gutter-md" id="makeItRain">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">
    <q-card class="q-pa-md">
      <q-card-section class="q-gutter-md">
        <div class="row items-center">
          <div class="col">
            <div class="text-h6 q-mb-xs">
              Paid Reviews â€” Settings ID: <span v-text="settings.id"></span>
            </div>
          </div>
        </div>

        <div class="row q-col-gutter-md q-mt-sm">
          <div class="col-12 col-md-3">
            <q-input type="number" filled dense v-model.number="settings.cost" label="Cost (sats)" min="0"></q-input>
          </div>

          <div class="col-12 col-md-4">
            <q-select filled dense emit-value v-model="settings.wallet" :options="g.user.walletOptions" :display-value="shortWallet(settings.wallet)" label="Wallet *"></q-select>
          </div>

          <div class="col-12 col-md-3">
            <q-input type="number" filled dense v-model.number="settings.comment_word_limit" label="Comment word limit" min="1"></q-input>
          </div>

          <div class="col-12 col-md-3">
            <q-input filled dense v-model="settings.name" label="Title" hint="Title for shareable page" lazy-rules
              :rules="[ val => val && val.length > 0 || 'Please type something']"></q-input>
          </div>

          <div class="col-12 col-md-3">
            <q-input dense filled v-model="settings.description" label="Description" hint="Description for shareable page" lazy-rules
              :rules="[ val => val && val.length > 0 || 'Please type something']"></q-input>
          </div>

          <div class="col-12 col-md-4">
                       <q-select
  filled dense multiple use-chips use-input hide-dropdown-icon
  v-model="settings.tags"
  :options="tagOptions"
  label="Tags"
  new-value-mode="add-unique"
  @new-value="onNewTag"
  hint="Type a tag and press Enter to add"
></q-select>
          </div>
        </div>

        <div class="row items-center">
          <div class="col-auto">
            <q-btn color="primary" class="q-mr-md float-right" unelevated @click="saveSettings" :loading="savingSettings">
              Save Settings
            </q-btn>
          </div>
        </div>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="row items-center">
          <div class="col-8">
            <div class="text-h6 q-mb-xs">
              Reviews for "<span v-text="selectedTag"></span>"
              <q-btn size="sm" color="primary" dense unelevated icon="launch" v-if="settings.id"
                :href="`/paidreviews/` + settings.id + `/` + selectedTag" target="_blank" type="a"></q-btn>
            </div>
          </div>
          <div class="col-4 float-right">
            <q-rating class="float-right" readonly icon="star_border" icon-selected="star" icon-half="star_half"
              :model-value="avgRating" size="sm" color="secondary"></q-rating>
            <span class="float-right q-mr-sm" v-text="avgRating"></span>
            <span class="float-right q-mr-md">(<span v-text="reviewCount"></span>)</span>
          </div>
        </div>

        <div class="row items-center q-col-gutter-md">
          <div class="q-pt-none col-12 col-md-3 self-start q-pt-lg">
            <q-select filled dense clearable v-model="selectedTag" :options="settings.tags" label="Filter by tag" @update:model-value="resetAndLoad" />
          </div>
          
          <div class="col-12 col-md-9">
            <div class="q-clearfix"></div>
            <q-list>
              <q-item v-for="(review, index) in allReviews" :key="review.id" clickable>
                <q-item-section>
                  <q-item-label>
                    <div class="text-subtitle2 text-grey-4">
                      <strong><span v-text="review.name"></span></strong>
                      <small>
                        (<span v-text="new Date(Number(review.created_at) * 1000).toLocaleString()"></span>)
                      </small>
                      <q-btn @click="deleteReview(review.id)" size="sm" icon="delete" color="negative" flat></q-btn>
                    </div>
                    <div class="text-body2" style="white-space: pre-wrap">
                      <span v-text="review.comment"></span>
                    </div>
                  </q-item-label>
                </q-item-section>
                <q-item-section side top>
                  <q-rating readonly icon="star_border" icon-selected="star" icon-half="star_half"
                    :model-value="fixRating(review.rating)" size="xs" color="secondary"></q-rating>
                </q-item-section>
              </q-item>
            </q-list>
          </div>
        </div>

        <q-card-actions align="between">
          <div>
            <q-btn flat icon="chevron_left" label="Back" :disable="!canGoBack" @click="goBack" />
          </div>
          <div class="text-caption">Page size: {{ limit }}</div>
          <div>
            <q-btn flat icon-right="chevron_right" label="Next" :disable="!nextCursor" @click="goNext" />
          </div>
        </q-card-actions>
      </q-card-section>
    </q-card>
  </div>

  <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">
    <q-card class="q-pa-md">
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">
          {{SITE_TITLE}} - Paid Reviews Extension
        </h6>
        <p class="q-mt-sm">
          Charge for people to leave reviews <br />
          Designed to be used via api, but public page included
        </p>
      </q-card-section>
      <q-card-section class="q-pa-none">
        <q-separator></q-separator>
        <q-list>
          {% include "paidreviews/_api_docs.html" %}
          <q-separator></q-separator>
          {% include "paidreviews/_paidreviews.html" %}
        </q-list>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}
