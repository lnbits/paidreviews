{% extends "public.html" %} {% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-10 text-h5 q-mb-xs">
    <span v-text="pr_name"></span> - <span v-text="pr_description"></span>
  </div>
  <div class="col-12 col-lg-7 q-gutter-y-md" style="order: 1">
    <q-card>
      <q-card-section>
        <div class="text-h6 q-mb-xs">
          <small
            >Tag: "<b><span v-text="pr_tag"></span></b>"</small
          >
          <q-rating
            class="float-right q-pt-xs"
            readonly
            icon="star_border"
            icon-selected="star"
            icon-half="star_half"
            :model-value="avgRating"
            size="sm"
            color="secondary"
          ></q-rating>
          <small
            ><span class="float-right q-mr-sm" v-text="avgRating"></span>
            <span class="float-right q-mr-md"
              >(<span v-text="pr_review_count"></span>)</span
            ></small
          >
        </div>
      </q-card-section>

      <q-separator></q-separator>

      <q-card-section>
        <q-table
          :rows="reviews"
          :columns="reviewsTable.columns"
          v-model:pagination="reviewsTable.pagination"
          @request="getTagReviews"
          :loading="reviewsTable.loading"
          row-key="name"
          :filter="reviewsTable.search"
        >
          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td key="name" :props="props">
                <span v-text="props.row.name"></span>
              </q-td>
              <q-td key="comment" :props="props">
                <span v-text="props.row.comment"></span>
              </q-td>
              <q-td key="rating" :props="props">
                <q-rating
                  class="float-right q-pt-xs"
                  readonly
                  icon="star_border"
                  icon-selected="star"
                  icon-half="star_half"
                  :model-value="fixRating(props.row.rating)"
                  size="sm"
                  color="secondary"
                ></q-rating>
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-sm-6 col-md-6 col-lg-3" style="order: 2">
    <q-card class="q-pa-lg q-pb-xl">
      <q-card-section class="q-pa-none">
        <div class="text-center">
          <q-form @submit="onSubmit">
            <q-input
              dense
              filled
              v-model="name"
              label="Your name *"
              lazy-rules
              :rules="[ val => val && val.length > 0 || 'Please type something']"
            ></q-input>
            <div class="q-gutter-y-md column" style="max-width: 500px">
              <q-input
                dense
                v-model="text"
                :label="'Your review (max ' + pr_comment_word_limit + ' words)'"
                filled
                type="textarea"
              ></q-input>
            </div>
            <div class="q-gutter-y-md column">
              <q-rating
                dense
                v-model="rating"
                size="sm"
                max="10"
                color="primary"
                icon="star_border"
                icon-selected="star"
              ></q-rating>
            </div>
            <div>
              <q-btn
                label="Submit"
                type="submit"
                class="float-right"
                color="primary"
              ></q-btn>
            </div>
          </q-form>
        </div>
      </q-card-section>
    </q-card>
  </div>
</div>

<q-dialog v-model="payment.show" position="top">
  <q-card class="q-pa-lg lnbits__dialog-card">
    <center>
      <p>Pay this invoice to submit review</p>
    </center>
    <q-responsive :ratio="1" class="q-mx-xl q-mb-xl">
      <lnbits-qrcode
        :value="payment.invoice"
        :options="{width: 800}"
        class="rounded-borders"
      ></lnbits-qrcode>
    </q-responsive>

    <div class="row q-mt-xl">
      <q-btn v-close-popup flat color="grey" class="q-mr-auto">Close</q-btn>
    </div>
  </q-card>
</q-dialog>
{% endblock %} {% block scripts %}
<script>
  const pr_reviews = {{ pr_reviews | tojson | safe }}
  const initialAvg = '{{pr_avg_rating}}'

  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    data() {
      return {
        pr_settings_id: '{{pr_settings_id}}',
        pr_name: '{{pr_name}}',
        pr_description: '{{pr_description}}',
        pr_tag: '{{pr_tag}}',
        pr_cost: '{{pr_cost}}',
        pr_comment_word_limit: '{{pr_comment_word_limit}}',

        // list + stats
        pr_reviews: pr_reviews || [],
        pr_avg_rating: isNaN(initialAvg) ? 0 : initialAvg,
        pr_review_count: Array.isArray(pr_reviews) ? pr_reviews.length : 0,

        // pagination
        limit: 10,
        nextCursor: null,
        cursorStack: [null], // track cursors to support "Back"
        loading: false,

        // review form
        name: '',
        rating: 0,
        text: '',

        // invoice dialog
        payment: {
          show: false,
          invoice: '',
          hash: ''
        },
        reviews: [],
        reviewsTable: {
          loading: false,
          columns: [
            {
              name: 'name',
              align: 'left',
              label: this.$t('Name'),
              field: 'name',
              sortable: true
            },
            {
              name: 'comment',
              align: 'left',
              label: this.$t('Comment'),
              field: 'comment'
            },
            {
              name: 'rating',
              align: 'right',
              label: 'Rating',
              field: 'rating',
            }
          ],
          pagination: {
            rowsPerPage: 10,
            sortBy: 'created_at',
            descending: true,
            page: 1
          }
        }
      }
    },
    computed: {
      canGoBack() {
        return this.cursorStack.length > 1
      },
      avgRating() {
        const v = Math.round(this.pr_avg_rating) / 2 / 100
        // snap to nearest 0.5
        const snapped = Math.round(v * 2) / 2
        return snapped
      }
    },

    methods: {
      async getTagReviews(props) {
        try {
          this.reviewsTable.loading = true
          const params = LNbits.utils.prepareFilterQuery(this.reviewsTable, props)
          const { data } = await LNbits.api.request(
            'GET',
            `/paidreviews/api/v1/reviews/${this.pr_settings_id}/${this.pr_tag}?${params}`,
            null
          )
          this.reviews = data.data
          this.reviewsTable.pagination.rowsNumber = data.total
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        } finally {
          this.reviewsTable.loading = false
        }
      },

      async onSubmit() {
        const review = {
          settings_id: this.pr_settings_id,
          name: this.name,
          tag: this.pr_tag,
          rating: this.rating * 100, // your backend expects 0..1000
          comment: this.text
        }

        const submit_review = await LNbits.api.request('POST', `/paidreviews/api/v1/reviews/${this.pr_settings_id}`, null, review)
          .then(r => r.data)
          .catch(e => {
            console.log(e)
            const detail = e?.response?.data?.detail || e?.message || 'Unknown error'
            this.$q.notify({ type: 'negative', message: detail, position: 'bottom' })
            return null
          })

        if (!submit_review) return

        if (submit_review.payment_request) {
          this.payment.invoice = submit_review.payment_request
          this.payment.hash = submit_review.payment_hash
          this.payment.show = true
          this.$q.notify({ type: 'positive', message: 'Please pay the invoice to submit your review.', position: 'bottom' })
          this.websocket(this.payment.hash)
        } else if (submit_review.message === true) {
          this.$q.notify({ type: 'positive', message: 'Message posted.', position: 'bottom' })
          this.onReset()
          this.getTagReviews()
        } else {
          this.$q.notify({ type: 'negative', message: 'Please try again.', position: 'bottom' })
        }
      },

      onReset() {
        this.name = ''
        this.rating = 0
        this.text = ''
        this.payment.show = false
      },

      fixRating(rating) {
        // convert 0..1000 -> 0..5 with .5 steps
        return Math.round((rating / 2 / 100) * 2) / 2
      },

      websocket(hash) {
        const url = new URL(window.location)
        url.protocol = url.protocol === 'https:' ? 'wss:' : 'ws:'
        url.pathname = `/api/v1/ws/${hash}`
        const ws = new WebSocket(url)
        ws.addEventListener('message', async () => {
          this.$q.notify({ type: 'positive', message: 'Invoice Paid' })
          this.onReset()
          ws.close()
          setTimeout(async () => {
            await this.getTagReviews()
          }, 3000)
        })
      }
    },
    async created() {
      await this.getTagReviews()
    }
  })
</script>
{% endblock %}
